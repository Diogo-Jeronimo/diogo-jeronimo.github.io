<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title></title>
		<style>
body {
	background-color: #222;
	color: white;
	font-size: 2vw;
}
main {
	display: grid;
	grid-template-areas: "now now" "day hour";
	gap: 5vw;
	justify-content: space-evenly;
	justify-items: center;
	align-items: start;
}
#current {
	text-align: center;
	font-size: 3vw;
	grid-area: now;
}
#daily_table {
	grid-area: day;
}
#hourly_table {
	grid-area: hour;
}
tr {
	text-align: center;
}
td:nth-child(3){
	text-align: start;
}
caption {
	caption-side: top;
}

@media (max-width: 600px) {
	body {
		font-size: 4vw;
	}
	main {
		grid-template-areas: "now" "day" "hour";
	}
	#current {
		font-size: 5vw;
	}
}
		</style>
	</head>
	<body>
		<main>
			<h1 id="current">?: ‚ùî--:-- ‚ùî-</h1>
			<table id="daily_table">
				<caption>Daily forecast</caption>
				<thead>
					<tr>
						<th scope="col">Day</th>
						<th scope="col">Summary</th>
						<th scope="col">Description</th>
					</tr>
				</thead>
				<tbody id="daily"></tbody>
			</table>
			<table id="hourly_table">
				<caption>Hourly forecast</caption>
				<thead>
					<tr>
						<th scope="col">Real</th>
						<th scope="col">Ingame</th>
						<th scope="col">Weather</th>
					</tr>
				</thead>
				<tbody id="hourly"></tbody>
			</table>
		</main>
		<script>
const cycle = ["Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Misty","Misty","Misty","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Clear","Clear","Clear","Misty","Misty","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Misty","Misty","Misty","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Hazy","Hazy","Hazy","Hazy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Misty","Misty","Misty","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Foggy","Foggy","Foggy","Foggy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Foggy","Foggy","Foggy","Foggy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Partly Cloudy","Drizzling","Drizzling","Drizzling","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Misty","Misty","Misty","Partly Cloudy","Partly Cloudy","Partly Cloudy","Raining","Raining","Raining","Drizzling","Drizzling","Drizzling","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Misty","Misty","Misty","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Foggy","Foggy","Foggy","Foggy","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Foggy","Foggy","Foggy","Foggy","Foggy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Misty","Misty","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Mostly Clear","Misty","Misty","Mostly Clear","Raining","Raining","Raining","Drizzling","Drizzling","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Misty","Misty","Partly Cloudy","Partly Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Misty","Misty","Misty","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Mostly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Clear","Partly Cloudy","Partly Cloudy","Raining","Raining","Raining","Raining","Raining","Raining","Raining","Drizzling","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy","Partly Cloudy"];
const weatherToIcon = {
	"Clear": "üå§Ô∏è",
	"Mostly Clear": "üå§Ô∏è",
	"Partly Cloudy": "üå§Ô∏è",
	"Mostly Cloudy": "üå§Ô∏è",
	"Cloudy": "üå§Ô∏è",
	"Hazy": "üå§Ô∏è",
	"Misty": "üå§Ô∏è",
	"Foggy": "üå´Ô∏è",
	"Drizzling": "üå¶Ô∏è",
	"Raining": "üåßÔ∏è"
};
const gtaEpoch = () => Math.floor(Date.now() * 30); // 1 second = 30 gta seconds
const gtaTime = (epoch, mode) => {
	const dateObj = new Date(epoch);
	const hours = dateObj.getUTCHours();
	const timeIcon = (h => {
		switch(h) {
			case 5: case 20: case 21: return "üåÜ";
			case 18: case 19: return "üåá";
			default: return h <= 4 || h >= 22 ? "üåÉ" : "üèôÔ∏è";
		}
	})(hours);
	if(mode == "icon") {
		return timeIcon;
	}
	const formattedHours = hours.toString().padStart(2, "0");
	const formattedMinutes = dateObj.getUTCMinutes().toString().padStart(2, "0");
	const weekDay = dateObj.toLocaleDateString("en", {weekday: "short"});
	return `${weekDay} ${timeIcon}${formattedHours}:${formattedMinutes}`;
};
const gtaWeather = (epoch, mode) => {
	const epochHours = Math.floor(epoch / 1000 / 60 / 60);
	const cycleHour = epochHours % cycle.length;
	const weather = cycle[cycleHour];
	const weatherIcon = weatherToIcon[weather];
	return mode == "icon" ? weatherIcon : mode == "text" ? weather : `${weatherIcon}"${weather}"`;
};
const combinedIcon = epoch => {
	const timeIcon = gtaTime(epoch, "icon");
	const weatherIcon = gtaWeather(epoch, "icon");
	if(["üåßÔ∏è", "üå¶Ô∏è", "üå´Ô∏è"].includes(weatherIcon) || timeIcon == "üèôÔ∏è") {
		return weatherIcon;
	}
	return timeIcon == "üåÉ" ? "üåô" : timeIcon;
};
const dateTimeFormat = (epoch, mode) => {
	const dateObj = new Date(epoch);
	if(mode == "w") {
		return dateObj.toLocaleDateString("en", {weekday: "short"});
	}
	const formattedHours = dateObj.getUTCHours().toString().padStart(2, "0");
	if(mode == "h") {
		return formattedHours + "h";
	}
	const formattedMinutes = dateObj.getUTCMinutes().toString().padStart(2, "0");
	if(mode == "h:m") {
		return `${formattedHours}:${formattedMinutes}`;
	}
	return dateObj.toISOString();
};
const h1 = document.getElementById("current");
const tbodyH = document.getElementById("hourly");
const tbodyD = document.getElementById("daily");
const urlParams = new URLSearchParams(window.location.search);
const forecastHours = urlParams.get("h") ?? 24;
for(let i = 0; i < forecastHours; i++) {
	const row = tbodyH.insertRow(-1);
	row.insertCell(0);
	row.insertCell(1);
	row.insertCell(2);
}
const forecastDays = urlParams.get("d") ?? 7;
for(let i = 0; i < forecastDays; i++) {
	const row = tbodyD.insertRow(-1);
	row.insertCell(0);
	row.insertCell(1);
	row.insertCell(2);
}
const drawHourly = currentGTAEpoch => {
	const gtaDate = new Date(currentGTAEpoch);
	gtaDate.setUTCMinutes(60);
	for(let i = 0; i < forecastHours; i++) {
		const row = tbodyH.rows[i];
		row.cells[0].innerText = dateTimeFormat(Math.floor(gtaDate.getTime() / 30), "h:m");
		row.cells[1].innerText = dateTimeFormat(gtaDate.getTime(), "h");
		row.cells[2].innerText = `${combinedIcon(gtaDate.getTime())} ${gtaWeather(gtaDate.getTime(), "text")}`;
		gtaDate.setUTCMinutes(60);
	}
};
const drawDaily = currentGTAEpoch => {
	const gtaDate = new Date(currentGTAEpoch);
	gtaDate.setUTCHours(0);
	for(let i = 0; i < forecastDays; i++) {
		const row = tbodyD.rows[i];
		row.cells[0].innerText = dateTimeFormat(gtaDate.getTime(), "w");
		const rainHours = [], drizzleHours = [], foggyHours = [];
		for(let j = 0; j < 24; j++) {
			gtaDate.setUTCHours(j);
			const weather = gtaWeather(gtaDate.getTime(), "icon");
			switch(weather) {
				case "üåßÔ∏è": rainHours.push(j); break;
				case "üå¶Ô∏è": drizzleHours.push(j); break;
				case "üå´Ô∏è": foggyHours.push(j);
			}
		}
		row.cells[1].innerText = rainHours.length > 0 ? "üåßÔ∏è" : drizzleHours.length > 0 ? "üå¶Ô∏è" : foggyHours.length > 0 ? "üå´Ô∏è" : "üå§Ô∏è";
		let description = "";
		let start = null, end = null;
		for(let i = 0; i < rainHours.length; i++) {
			if(i === 0) {
				start = rainHours[0];
				description = "Rain:";
				continue;
			}
			if(rainHours[i] == rainHours[i - 1] + 1) {
				end = rainHours[i];
			} else {
				if(end === null) {
					description += "," + start;
				} else {
					description += "," + start + "‚Äì" + end;
					end = null;
				}
				start = rainHours[i];
			}
		}
		if(start !== null) {
			description += "," + start + (end === null ? "" : "‚Äì" + end);
		}
		start = null, end = null;
		for(let i = 0; i < drizzleHours.length; i++) {
			if(i === 0) {
				start = drizzleHours[0];
				description += " Drizzle:";
				continue;
			}
			if(drizzleHours[i] == drizzleHours[i - 1] + 1) {
				end = drizzleHours[i];
			} else {
				if(end === null) {
					description += "," + start;
				} else {
					description += "," + start + "‚Äì" + end;
					end = null;
				}
				start = drizzleHours[i];
			}
		}
		if(start !== null) {
			description += "," + start + (end === null ? "" : "‚Äì" + end);
		}
		start = null, end = null;
		for(let i = 0; i < foggyHours.length; i++) {
			if(i === 0) {
				start = foggyHours[0];
				description += " Fog:";
				continue;
			}
			if(foggyHours[i] == foggyHours[i - 1] + 1) {
				end = foggyHours[i];
			} else {
				if(end === null) {
					description += "," + start;
				} else {
					description += "," + start + "‚Äì" + end;
					end = null;
				}
				start = foggyHours[i];
			}
		}
		if(start !== null) {
			description += "," + start + (end === null ? "" : "‚Äì" + end);
		}
		row.cells[2].innerText = description.trim().replaceAll(":,", ":");
		gtaDate.setUTCHours(24);
	}
};
const draw = () => {
	const currentGTAEpoch = gtaEpoch();
	document.title = "GTAO: " + combinedIcon(currentGTAEpoch) + dateTimeFormat(currentGTAEpoch, "h:m");
	h1.innerHTML = `Los Santos: ${gtaTime(currentGTAEpoch)} ${gtaWeather(currentGTAEpoch).replace(" ", "&nbsp;")}`;
	const gtaDate = new Date(currentGTAEpoch);
	if(gtaDate.getUTCMinutes() === 0) {
		drawHourly(currentGTAEpoch);
		if(gtaDate.getUTCHours() === 0) {
			drawDaily(currentGTAEpoch);
		}
	}
};
draw();
drawHourly(gtaEpoch());
drawDaily(gtaEpoch());
setInterval(draw, 1900);
		</script>
	</body>
</html>
